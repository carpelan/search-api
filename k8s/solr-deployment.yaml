---
apiVersion: v1
kind: Namespace
metadata:
  name: search-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: solr-init
  namespace: search-system
data:
  init.sh: |
    #!/bin/bash
    set -e

    # Wait for Solr to be ready
    echo "Waiting for Solr to start..."
    until curl -s http://localhost:8983/solr/ > /dev/null; do
      sleep 2
    done

    echo "Solr is up, creating core..."

    # Create core if it doesn't exist
    if ! curl -s "http://localhost:8983/solr/admin/cores?action=STATUS&core=metadata" | grep -q '"name":"metadata"'; then
      curl "http://localhost:8983/solr/admin/cores?action=CREATE&name=metadata&configSet=_default"
      echo "Core 'metadata' created successfully"
    else
      echo "Core 'metadata' already exists"
    fi

    # Configure schema for Riksarkivet metadata
    echo "Configuring schema for Riksarkivet archive documents..."

    # Add fields for Riksarkivet archive metadata
    curl -X POST -H 'Content-type:application/json' --data-binary '{
      "add-field": [
        {"name":"reference_code", "type":"string", "stored":true, "indexed":true},
        {"name":"title", "type":"text_general", "stored":true, "indexed":true},
        {"name":"description", "type":"text_general", "stored":true, "indexed":true},
        {"name":"institution", "type":"string", "stored":true, "indexed":true},
        {"name":"institution_location", "type":"string", "stored":true, "indexed":true},
        {"name":"collection_name", "type":"text_general", "stored":true, "indexed":true},
        {"name":"date_start", "type":"pdate", "stored":true, "indexed":true},
        {"name":"date_end", "type":"pdate", "stored":true, "indexed":true},
        {"name":"date_display", "type":"string", "stored":true, "indexed":false},
        {"name":"page_numbers", "type":"pints", "stored":true, "indexed":true, "multiValued":true},
        {"name":"total_pages", "type":"pint", "stored":true, "indexed":true},
        {"name":"full_text", "type":"text_general", "stored":true, "indexed":true},
        {"name":"text_snippets", "type":"text_general", "stored":true, "indexed":false, "multiValued":true},
        {"name":"iiif_manifest_url", "type":"string", "stored":true, "indexed":false},
        {"name":"iiif_image_url", "type":"string", "stored":true, "indexed":false},
        {"name":"alto_xml_url", "type":"string", "stored":true, "indexed":false},
        {"name":"viewer_url", "type":"string", "stored":true, "indexed":false},
        {"name":"document_type", "type":"string", "stored":true, "indexed":true},
        {"name":"subjects", "type":"strings", "stored":true, "indexed":true, "multiValued":true},
        {"name":"language", "type":"string", "stored":true, "indexed":true},
        {"name":"access_conditions", "type":"string", "stored":true, "indexed":true},
        {"name":"rights", "type":"string", "stored":true, "indexed":true},
        {"name":"indexed_date", "type":"pdate", "stored":true, "indexed":true},
        {"name":"modified_date", "type":"pdate", "stored":true, "indexed":true},
        {"name":"source_api", "type":"string", "stored":true, "indexed":true}
      ]
    }' http://localhost:8983/solr/metadata/schema || true

    echo "Schema configured successfully"
---
apiVersion: v1
kind: Service
metadata:
  name: solr
  namespace: search-system
spec:
  selector:
    app: solr
  ports:
    - name: http
      port: 8983
      targetPort: 8983
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: solr
  namespace: search-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: solr
  template:
    metadata:
      labels:
        app: solr
    spec:
      initContainers:
        - name: init-solr
          image: solr:9.4
          command: ["/scripts/init.sh"]
          volumeMounts:
            - name: init-script
              mountPath: /scripts
            - name: solr-data
              mountPath: /var/solr
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - -c
                  - |
                    solr start -force
                    /scripts/init.sh
                    solr stop -force
      containers:
        - name: solr
          image: solr:9.4
          ports:
            - containerPort: 8983
              name: http
          env:
            - name: SOLR_HEAP
              value: "512m"
            - name: SOLR_JAVA_MEM
              value: "-Xms512m -Xmx512m"
          volumeMounts:
            - name: solr-data
              mountPath: /var/solr
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /solr/admin/info/system
              port: 8983
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /solr/admin/info/system
              port: 8983
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: init-script
          configMap:
            name: solr-init
            defaultMode: 0755
        - name: solr-data
          emptyDir: {}
