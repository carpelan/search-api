version: '3.8'

services:
  solr:
    image: solr:9.4
    container_name: search-api-solr
    ports:
      - "8983:8983"
    environment:
      - SOLR_HEAP=512m
      - SOLR_JAVA_MEM=-Xms512m -Xmx512m
    volumes:
      - solr-data:/var/solr
    command:
      - bash
      - -c
      - |
        solr-precreate metadata /opt/solr/server/solr/configsets/_default

        # Wait for Solr to be ready
        until curl -s http://localhost:8983/solr/ > /dev/null; do
          sleep 2
        done

        # Configure schema
        curl -X POST -H 'Content-type:application/json' --data-binary '{
          "add-field": [
            {"name":"title", "type":"text_general", "stored":true, "indexed":true},
            {"name":"description", "type":"text_general", "stored":true, "indexed":true},
            {"name":"author", "type":"string", "stored":true, "indexed":true},
            {"name":"created_date", "type":"pdate", "stored":true, "indexed":true},
            {"name":"modified_date", "type":"pdate", "stored":true, "indexed":true},
            {"name":"tags", "type":"strings", "stored":true, "indexed":true, "multiValued":true},
            {"name":"content_type", "type":"string", "stored":true, "indexed":true},
            {"name":"file_size", "type":"plong", "stored":true, "indexed":true},
            {"name":"full_text", "type":"text_general", "stored":true, "indexed":true}
          ]
        }' http://localhost:8983/solr/metadata/schema || true

        # Keep running
        tail -f /dev/null
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8983/solr/admin/info/system || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  search-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: search-api
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - Solr__Url=http://solr:8983/solr/metadata
      - ASPNETCORE_URLS=http://+:8080
    depends_on:
      solr:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  solr-data:
    driver: local
